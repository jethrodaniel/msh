require "erb"
require "bundler/gem_tasks"
require "rake/clean"

CLEAN << "docs" << "pkg"

task :default => %i[msh build install spec]

desc "build everything and run msh"
task :run => :msh do
  sh "bundle exec ruby exe/msh"
end

desc "build everything"
task :msh => :man

desc "generates readme.md from ERB"
task :readme => [:msh, "readme.md"]

file "readme.md" do |t|
  template = File.read "#{t.name}.erb"
  puts "#{t.name}.erb -> #{t.name}"
  # trim mode of `<>` removes newlines and blank lines
  erb_string = ERB.new(template, nil, :trim_mode => "-").result
  File.open(t.name, "w") { |f| f.puts erb_string }
end

task :test do
  sh "bundle exec bench #{Dir["test/**/*_test.rb"].join(' ')}"
end

task :consolidate do
  sh "gem consolidate lib/msh.rb --footer='Msh.start' --header='#!/usr/bin/env ruby' 1>msh && chmod u+x msh"
end

Dir["lib/tasks/*.rake"].each(&method(:load))
