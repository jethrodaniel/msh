require "bundler/gem_tasks"
require "rake/clean"
require "erb"

CLEAN << %w[docs pkg]

task :default => %i[msh build install spec mruby]

##-- Build

desc "build everything and run msh"
task :run => :msh do
  sh "bundle exec ruby exe/msh"
end

desc "build everything"
task :msh => :man

desc "generates readme.md from ERB"
task :readme => [:msh, "readme.md"]

file "readme.md" do |t|
  template = File.read "#{t.name}.erb"
  puts "#{t.name}.erb -> #{t.name}"
  # trim mode of `<>` removes newlines and blank lines
  erb_string = ERB.new(template, nil, :trim_mode => "-").result
  File.open(t.name, "w") { |f| f.puts erb_string }
end

##-- Testing

require "rspec/core/rake_task"

task :test => :spec
RSpec::Core::RakeTask.new :spec

##-- Tools

%i[lexer parser].each do |cmd|
  desc "run the #{cmd}"
  task cmd do
    sh "bundle exec msh -c #{cmd}"
  end
end

require "rubocop/rake_task"
RuboCop::RakeTask.new :lint do |t|
  t.options = %w[--display-cop-names -c.rubocop.yml]
end

##-- Etc

desc "install tar v1.32 (needed for pkg)"
task :tar => "third_party/tar-1.32" do
  Dir.chdir "third_party/tar-1.32" do
    sh "./configure && sudo make && sudo make install"
  end
end
file "third_party/tar-1.32.tar.gz" do
  sh "wget https://ftp.gnu.org/gnu/tar/tar-1.32.tar.gz -P third_party"
end
file "third_party/tar-1.32" => "third_party/tar-1.32.tar.gz" do
  Dir.chdir "third_party" do
    sh "tar xzvf tar-1.32.tar.gz"
  end
end

##-- Additional tasks
Dir["lib/tasks/*.rake"].each(&method(:load))
